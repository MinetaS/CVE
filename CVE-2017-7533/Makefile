CC = musl-gcc
ASM = nasm
CFLAGS = -lpthread -static -mmanual-endbr -masm=intel
PATH_LINUX = /media/Disk1/linux

all: main

main: main.o exploit.o kfops.o inotify.o rename.o iovec.o 
	${CC} ${CFLAGS} $^ -o $@

main.o: CVE-2017-7533.c conf.h types.h
	${CC} -masm=intel CVE-2017-7533.c -c -o $@

exploit.o: exploit.s
	${ASM} exploit.s -f elf64 -o $@

kfops.o: kfops.c conf.h types.h
	${CC} kfops.c -c -o $@

inotify.o: inotify.c conf.h
	${CC} inotify.c -c -o $@

rename.o: rename.c conf.h
	${CC} rename.c -c -o $@

iovec.o: iovec.c conf.h types.h
	${CC} iovec.c -c -o $@

copy:
	mount "${PATH_LINUX}/rootfs.ext4" /media/kernel
	sleep 1
	cp main /media/kernel/home/test
	sleep 1
	umount /media/kernel

clean:
	rm -f *.o